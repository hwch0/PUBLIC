<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
      PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kr.pub.dao.AdminDAO">

<select id="getChartData" resultType="java.util.LinkedHashMap">
SELECT
    TO_CHAR(p.payment_date, 'yyyy-mm') AS payment_month,
    SUM(CASE WHEN p.payment_type_code = 'PT001' THEN o.total_price ELSE 0 END) AS PT001,
    SUM(CASE WHEN p.payment_type_code = 'PT002' THEN o.total_price ELSE 0 END) AS PT002,
    SUM(CASE
        WHEN p.payment_type_code = 'PT001' THEN o.total_price
        WHEN p.payment_type_code = 'PT002' THEN o.total_price
        ELSE 0
    END) AS total_sales
FROM
    payment p
JOIN (
    SELECT
        order_id,
        SUM(total_price) AS total_price
    FROM (
        SELECT
            item_id,
            order_id,
            (quantity * price) AS total_price
        FROM
            order_history
    ) sub
    GROUP BY
        order_id
) o ON o.order_id = p.order_id
GROUP BY
    TO_CHAR(p.payment_date, 'yyyy-mm')
ORDER BY payment_month

</select>


<select id="getPieChartData" resultType="java.util.LinkedHashMap">

select *
from 
(select i.item_id, i.item_name, merge.total_count, merge.total_sales, merge.ranking
from(
        select sub.*
            , rank() over (order by total_count desc) as ranking
        from (
        select item_id
        , sum(quantity) as total_count
        , sum(price) as total_sales
        from order_history h
        join orders o on h.order_id = o.order_id
        where item_id != 'ITEM000001'
			
		    <choose>
		        <when test="dateType == 'month'">
		            <![CDATA[
		            and to_char(order_date, 'yyyy-mm') = to_char(sysdate, 'yyyy-mm')
		            ]]>
		        </when>
		        <when test="dateType == 'day'">
		            <![CDATA[
		            and to_char(order_date, 'yyyy-mm-dd') = to_char(sysdate, 'yyyy-mm-dd')
		            ]]>
		        </when>
		        <otherwise>
		            <![CDATA[
		            and to_char(order_date, 'yyyy') = to_char(sysdate, 'yyyy')
		            ]]>
		        </otherwise>
		    </choose>
			
        
<![CDATA[        
        group by item_id) sub) merge
join item i
on i.item_id = merge.item_id
order by merge.ranking)
where rownum <7
]]>
        
</select>


<select id="getUserCount" resultType="java.util.LinkedHashMap">

select to_char(login_time, 'yyyy-mm-dd') as day
	, count(user_id) as userCount
from user_history 
group by to_char(login_time, 'yyyy-mm-dd')
having to_char(login_time, 'yyyy-mm-dd') 
in (to_char(sysdate, 'yyyy-mm-dd'), to_char(sysdate -1, 'yyyy-mm-dd')
)
order by day
</select>

<select id="getMonthlyUsers" resultType="java.util.LinkedHashMap">
select to_char(login_time, 'yyyy-mm') as month
, count(user_id) userCount
from user_history 
group by to_char(login_time, 'yyyy-mm')
order by month
</select>


	
</mapper>